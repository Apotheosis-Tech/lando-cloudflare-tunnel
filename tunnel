#!/bin/bash

# Global Tunnel Launcher - Run tunnel commands from anywhere in your project
# Usage: tunnel [command] [args...]

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# Find the tunnel directory by looking up the directory tree
find_tunnel_dir() {
    local current_dir="$(pwd)"
    
    while [ "$current_dir" != "/" ]; do
        if [ -d "$current_dir/tunnel" ] && [ -f "$current_dir/tunnel/smart-start.sh" ]; then
            echo "$current_dir/tunnel"
            return 0
        fi
        current_dir="$(dirname "$current_dir")"
    done
    
    return 1
}

# Find tunnel directory
TUNNEL_DIR=$(find_tunnel_dir)

if [ -z "$TUNNEL_DIR" ]; then
    echo -e "${RED}‚ùå Could not find tunnel directory!${NC}"
    echo "Make sure you have a 'tunnel/' directory with tunnel scripts in your project."
    echo "Run this command from within your Lando project directory tree."
    exit 1
fi

echo -e "${GREEN}üìç Found tunnel directory: $TUNNEL_DIR${NC}"

# Default command is smart-start
COMMAND="${1:-smart-start}"
shift 2>/dev/null || true

# Execute the command
case "$COMMAND" in
    "start"|"smart-start")
        exec "$TUNNEL_DIR/smart-start.sh" "$@"
        ;;
    "background"|"bg")
        exec "$TUNNEL_DIR/start-background.sh" "$@"
        ;;
    "stop")
        exec "$TUNNEL_DIR/stop-tunnel.sh" "$@"
        ;;
    "status")
        exec "$TUNNEL_DIR/tunnel-status.sh" "$@"
        ;;
    "health"|"check")
        exec "$TUNNEL_DIR/health-check.sh" "$@"
        ;;
    "setup")
        exec "$TUNNEL_DIR/setup-domain.sh" "$@"
        ;;
    "help"|"-h"|"--help")
        echo "Tunnel Command Launcher"
        echo "======================="
        echo ""
        echo "Usage: tunnel [command]"
        echo ""
        echo "Commands:"
        echo "  start, smart-start    Start tunnel (interactive, default)"
        echo "  background, bg        Start tunnel in background"
        echo "  stop                  Stop tunnel"
        echo "  status                Check tunnel status"
        echo "  health, check         Run health check"
        echo "  setup                 Configure domain settings"
        echo "  help                  Show this help"
        echo ""
        echo "Examples:"
        echo "  tunnel                # Start tunnel (same as 'tunnel start')"
        echo "  tunnel bg             # Start in background"
        echo "  tunnel status         # Check if running"
        echo "  tunnel stop           # Stop tunnel"
        echo ""
        echo "Tunnel directory: $TUNNEL_DIR"
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $COMMAND${NC}"
        echo "Run 'tunnel help' for available commands."
        exit 1
        ;;
esac
